name: 'Dev Workflow'
on:
  push:
    branches:
      - dev
      - ft-ci-pipeline-10
  pull_request:
    branches:
      - dev

jobs:
  infra:
    name: 'Infra - Terraform'
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v2

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_DEV }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_DEV }}
        aws-region: us-east-1

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v1
      with:
        terraform_version: 0.12.28

    - name: Terraform Init
      run: terraform init -backend-config=envs/dev.backend.tf
      working-directory: ./infra

    - name: Terraform Validate
      run: terraform validate
      working-directory: ./infra

    - name: Terraform Plan
      run: terraform plan -var-file="values/dev.tfvars"
      working-directory: ./infra

    - name: Terraform Apply
      run: terraform apply -var-file="values/dev.tfvars" -auto-approve
      working-directory: ./infra

    - name: Terraform Outputs
      run: |
        export S3_BUCKET="$(cat envs/dev.backend.tf | grep bucket | cut -d'"' -f 2)"
        
        OUTPUTS=("ecr_repository" "ecr_repository_url" "frontend_bucket")
        for output in "${OUTPUTS[@]}"; do 
          echo "export $output=\"$(terraform output $output | grep -oP "(?<=::set-output name=stdout::).*")\" " >> terraform.outputs; 
        done
        
        sed -i -e 's/%0A//g' terraform.outputs
        aws s3 cp terraform.outputs s3://$S3_BUCKET
      working-directory: ./infra

  backend:
    needs: [infra]
    name: 'Backend - Python'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.7]

    steps:
    - name: Checkout
      uses: actions/checkout@v2

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v2
      with:
        python-version: ${{ matrix.python-version }}

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_DEV }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_DEV }}
        aws-region: us-east-1
    
    - name: Install dependencies
      run: |
        sudo pip install pipenv
        pipenv sync --dev --three
      working-directory: ./backend/
    
    - name: Run tests
      run: pipenv run coverage run --omit="tests/*" --include="app/*" --branch -m unittest discover -s tests/unit -p "*_test.py"
      working-directory: ./backend/
    
    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v1

    - name: Build and Deploy
      run: |
        export S3_BUCKET="$(cat ../infra/envs/dev.backend.tf | grep bucket | cut -d'"' -f 2)"
        aws s3 cp s3://$S3_BUCKET/terraform.outputs terraform.outputs
        source terraform.outputs

        export app_version=$(cat config.yaml | grep -oP "(?<=version:).*" | tr -d '[:space:]')
        
        docker build -t $ecr_repository .
        docker build -t $ecr_repository:$app_version .
        
        docker tag $ecr_repository:latest $ecr_repository_url:latest
        docker push $ecr_repository_url:latest
        
        docker tag $ecr_repository:$app_version $ecr_repository_url:$app_version
        docker push $ecr_repository_url:$app_version
      working-directory: ./backend/

  frontend:
    needs: [infra]
    name: 'Frontend - React/Node'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [12.18.1]

    steps:
    - name: Checkout
      uses: actions/checkout@v2

    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v1
      with:
        node-version: ${{ matrix.node-version }}

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_DEV }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_DEV }}
        aws-region: us-east-1
    
    - name: Install dependencies
      run: npm install
      working-directory: ./frontend/
    
    - name: Run tests
      run: npm test
      working-directory: ./frontend/
    
    - name: Build
      run: npm run build
      working-directory: ./frontend/
    
    - name: Deploy to S3
      run: |
        export S3_BUCKET="$(cat ../infra/envs/dev.backend.tf | grep bucket | cut -d'"' -f 2)"
        aws s3 cp s3://$S3_BUCKET/terraform.outputs terraform.outputs
        source terraform.outputs

        package_version=$(cat package.json \
          | grep version \
          | head -1 \
          | awk -F: '{ print $2 }' \
          | sed 's/[",]//g' \
          | tr -d '[[:space:]]')

        aws s3 sync ./build  s3://$frontend_bucket/$package_version
        aws s3 sync ./build s3://$frontend_bucket/latest
      working-directory: ./frontend/

  uptime:
    needs: [frontend, backend]
    name: 'Uptime 30 min'
    runs-on: ubuntu-latest
    steps:
    - name: sleep 30m
      run: sleep 5s #TODO: fix time
  
  infra-destroy:
    needs: [uptime]
    name: 'Destroy infra - Terraform'
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v2

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_DEV }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_DEV }}
        aws-region: us-east-1

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v1
      with:
        terraform_version: 0.12.28

    - name: Terraform Init
      run: terraform init -backend-config=envs/dev.backend.tf
      working-directory: ./infra

    - name: Terraform Validate
      run: terraform validate
      working-directory: ./infra

    # Destroy all resources but terraform state module
    - name: Terraform Destroy
      run: |
        echo "$(terraform state list | grep -vE module.terraform_state_backend*)" > resources_to_destroy
        sed -i '/\[command\]/d' resources_to_destroy
        sed -i '/::/d' resources_to_destroy

        echo 'terraform destroy -auto-approve -var-file="values/dev.tfvars" \' > destroy_script.sh

        while read resource; do
          echo "-target='$resource' \\" >> destroy_script.sh
        done < resources_to_destroy
        
        sed -i '$ s/.$//' destroy_script.sh
        bash destroy_script.sh;
      working-directory: ./infra